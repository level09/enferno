{% extends 'layout.html' %}
{% from "security/_macros.html" import render_field_with_errors %}

{% block head_js %}
{{ super() }}
<script src="{{ url_for('.static', filename='js/webauthn.js') }}"></script>
<script src="{{ url_for('.static', filename='js/base64.js') }}"></script>
{% endblock %}

{% block content %}
<v-container fluid class="pa-4">
    <v-card max-width="700" class="mx-auto">
        <v-card-title class="text-h5">
            <i class="ti ti-fingerprint mr-2"></i>
            Security Keys & Passkeys
        </v-card-title>
        <v-card-subtitle>
            Use hardware security keys or device passkeys for secure authentication
        </v-card-subtitle>

        <v-card-text>
            {% include "security/_messages.html" %}

            {% if not credential_options %}
            <!-- Add Device Form -->
            <v-card variant="outlined" class="mb-4">
                <v-card-title class="text-subtitle-1">
                    <i class="ti ti-plus mr-2"></i>
                    Add a Security Key or Passkey
                </v-card-title>
                <v-card-text>
                    <form action="{{ url_for_security('wan_register') }}" method="post" id="wan-register-form">
                        {{ wan_register_form.hidden_tag() }}

                        <v-text-field
                            name="name"
                            label="Device Name"
                            placeholder="e.g., YubiKey, MacBook Touch ID"
                            hint="Give this device a name you'll recognize"
                            persistent-hint
                            class="mb-4"
                        ></v-text-field>

                        {% if security.wan_allow_as_first_factor %}
                        <div class="mb-4">
                            <div class="text-subtitle-2 mb-2">Usage Type:</div>
                            {% for subfield in wan_register_form.usage %}
                            {{ render_field_with_errors(subfield) }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <v-btn color="primary" type="submit">
                            <i class="ti ti-plus mr-1"></i>
                            Add Device
                        </v-btn>
                    </form>

                    {% if wan_register_form.errors %}
                    <div class="mt-4">
                        {% for field, errors in wan_register_form.errors.items() %}
                        {% for error in errors %}
                        <v-alert type="error" variant="tonal" density="compact" class="mb-2">{{ error }}</v-alert>
                        {% endfor %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </v-card-text>
            </v-card>
            {% else %}
            <!-- Registration in Progress -->
            <v-card variant="outlined" class="mb-4">
                <v-card-text class="text-center pa-6">
                    <v-progress-circular indeterminate color="primary" size="48" class="mb-4"></v-progress-circular>
                    <div class="text-body-1">Waiting for your security key...</div>
                    <div class="text-caption text-medium-emphasis">Follow the prompts on your device</div>
                    <div id="wan-errors" class="mt-4"></div>
                </v-card-text>
            </v-card>

            <form action="{{ url_for_security('wan_register_response', token=wan_state) }}" method="post" id="wan-register-response-form">
                {{ wan_register_response_form.hidden_tag() }}
                <input type="hidden" id="credential" name="credential" value="">
            </form>
            {% endif %}

            {% if registered_credentials %}
            <!-- Registered Devices -->
            <div class="text-subtitle-1 font-weight-medium mb-3">
                <i class="ti ti-devices mr-2"></i>
                Registered Devices
            </div>

            <v-row>
                {% for cred in registered_credentials %}
                <v-col cols="12" md="6">
                    <v-card variant="outlined">
                        <v-card-text>
                            <div class="d-flex align-start">
                                <v-avatar color="primary" variant="tonal" class="mr-3">
                                    <i class="ti ti-usb" style="font-size: 20px;"></i>
                                </v-avatar>
                                <div class="flex-grow-1">
                                    <div class="font-weight-bold">{{ cred.name }}</div>
                                    <div class="text-caption text-medium-emphasis">
                                        {{ cred.usage }} Â· {{ cred.device_type }}<br>
                                        Last used: {{ cred.lastuse }}
                                    </div>
                                </div>
                                <v-btn icon variant="text" color="error" size="small" @click="deleteDevice('{{ cred.name }}')">
                                    <i class="ti ti-trash"></i>
                                </v-btn>
                            </div>
                        </v-card-text>
                    </v-card>
                </v-col>
                {% endfor %}
            </v-row>
            {% endif %}

            {% if security.support_mfa and security.multi_factor_recovery_codes %}
            <v-divider class="my-6"></v-divider>
            <v-card variant="outlined">
                <v-card-text class="d-flex align-center">
                    <v-avatar color="warning" variant="tonal" class="mr-4">
                        <i class="ti ti-lifebuoy" style="font-size: 24px;"></i>
                    </v-avatar>
                    <div class="flex-grow-1">
                        <div class="font-weight-medium">Recovery Codes</div>
                        <div class="text-caption text-medium-emphasis">Backup codes for account recovery</div>
                    </div>
                    <v-btn variant="outlined" color="primary" href="{{ url_for_security('mf_recovery_codes') }}">
                        Manage
                    </v-btn>
                </v-card-text>
            </v-card>
            {% endif %}
        </v-card-text>

        <v-card-actions class="pa-4">
            <v-btn variant="text" href="{{ url_for_security('two_factor_setup') }}">
                <i class="ti ti-chevron-left mr-1"></i>
                Back to 2FA Settings
            </v-btn>
        </v-card-actions>
    </v-card>
</v-container>
{% endblock %}

{% block js %}
<script>
    const { createApp } = Vue;
    const { createVuetify } = Vuetify;
    const vuetify = createVuetify(config.vuetifyConfig);

    const app = createApp({
        mixins: [layoutMixin],
        methods: {
            deleteDevice(credName) {
                if (!confirm('Delete this device?')) return;
                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
                axios.post('{{ url_for_security("wan_delete") }}', { name: credName, csrf_token: csrfToken })
                    .then(() => location.reload())
                    .catch(err => console.error(err));
            }
        },
        delimiters: ['${', '}']
    });

    registerEnfernoComponents(app);
    app.use(vuetify).mount('#app');

    {% if credential_options %}
    handleRegister('{{ credential_options|safe }}')
        .then((result) => {
            if (result.error_msg) {
                document.getElementById("wan-errors").innerHTML =
                    '<div class="v-alert v-alert--density-default v-alert--variant-tonal bg-error pa-4 rounded">' + result.error_msg + '</div>';
            } else {
                document.getElementById("credential").value = result.credential;
                document.getElementById("wan-register-response-form").submit();
            }
        });
    {% endif %}
</script>
{% endblock %}
