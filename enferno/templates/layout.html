<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Project Enferno</title>
    <meta name="description" content="A framework for the next decade">
    <meta name="author" content="Enferno">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/static/css/vuetify.min.css">
    <link rel="stylesheet" href="/static/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/static/css/app.css">

    {% block css %}{% endblock %}
</head>

<body class="{% block body_class %} {% endblock %}">
<v-app id="app">
    <v-layout class="rounded rounded-md">
        <v-app-bar color="primary">

            <v-app-bar-title>

                <a href="/"><img style="height: 60px; filter:invert()" class="pa-1" src="/static/img/enferno.svg"></a>


            </v-app-bar-title>
            <v-spacer></v-spacer>
            {% if current_user.is_authenticated %}
<!-- User menu moved to sidebar -->


            {% endif  %}
        </v-app-bar>

        <v-navigation-drawer v-model="drawer">
            <v-list>
                {% if current_user.is_authenticated %}
                    <!-- Super Admin Navigation -->
                    {% if current_user.is_superadmin %}
                        <v-list-subheader>Platform Management</v-list-subheader>
                        <v-list-item 
                            href="/dashboard" 
                            prepend-icon="mdi-view-dashboard"
                            title="Platform Overview"
                        ></v-list-item>
                        
                        <v-divider class="my-2"></v-divider>
                        <v-list-subheader>System Administration</v-list-subheader>
                        <v-list-item 
                            href="/users/" 
                            prepend-icon="mdi-account-group"
                            title="Manage Users"
                        ></v-list-item>
                        <v-list-item 
                            href="/activities/" 
                            prepend-icon="mdi-history"
                            title="Activity Log"
                        ></v-list-item>
                        
                        <!-- Current Workspace Context (if in workspace) -->
                        {% set current_workspace = get_current_workspace() %}
                        {% if current_workspace %}
                            <v-divider class="my-2"></v-divider>
                            <v-list-subheader>Current Workspace: {{ current_workspace.name }}</v-list-subheader>
                            <v-list-item 
                                href="/workspace/{{ current_workspace.id }}/" 
                                prepend-icon="mdi-briefcase"
                                title="Workspace Home"
                            ></v-list-item>
                            <v-list-item 
                                href="/workspace/{{ current_workspace.id }}/team/" 
                                prepend-icon="mdi-account-group"
                                title="Manage Team"
                            ></v-list-item>
                            <v-list-item 
                                href="/dashboard" 
                                prepend-icon="mdi-swap-horizontal"
                                title="Switch Workspace"
                            ></v-list-item>
                        {% endif %}
                        
                    {% else %}
                        <!-- Regular User Navigation -->
                        {% set current_workspace = get_current_workspace() %}
                        {% if current_workspace %}
                            <!-- User is in a workspace -->
                            <v-list-subheader>{{ current_workspace.name }}</v-list-subheader>
                            <v-list-item 
                                href="/workspace/{{ current_workspace.id }}/" 
                                prepend-icon="mdi-briefcase"
                                title="Workspace Home"
                            ></v-list-item>
                            
                            <!-- Show team management if user is workspace admin -->
                            {% if current_user.is_workspace_admin(current_workspace.id) %}
                                <v-list-item 
                                    href="/workspace/{{ current_workspace.id }}/team/" 
                                    prepend-icon="mdi-account-group"
                                    title="Manage Team"
                                ></v-list-item>
                            {% endif %}
                            
                            <!-- Show workspace switcher if user has multiple workspaces -->
                            {% if current_user.get_workspaces()|length > 1 %}
                                <v-list-item 
                                    href="/dashboard" 
                                    prepend-icon="mdi-swap-horizontal"
                                    title="Switch Workspace"
                                ></v-list-item>
                            {% endif %}
                        {% else %}
                            <!-- User has no workspace access -->
                            <v-list-subheader>Getting Started</v-list-subheader>
                            <v-list-item 
                                href="/dashboard" 
                                prepend-icon="mdi-view-dashboard"
                                title="Dashboard"
                            ></v-list-item>
                            <v-list-item 
                                prepend-icon="mdi-help-circle"
                                title="Contact Admin"
                                subtitle="Request workspace access"
                            ></v-list-item>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <!-- Unauthenticated Navigation -->
                    <v-list-item href="/login" prepend-icon="mdi-login" title="Login"></v-list-item>
                    <v-list-item href="/register" prepend-icon="mdi-account-plus" title="Sign Up"></v-list-item>
                {% endif %}
            </v-list>
            
            <!-- User Profile Section at Bottom -->
            {% if current_user.is_authenticated %}
            <template v-slot:append>
                <v-divider class="mb-2"></v-divider>
                
                <!-- User Info Card -->
                <div class="pa-3">
                    <v-card variant="flat" color="transparent" class="d-flex align-center">
                        <v-avatar size="36" color="primary" class="mr-3">
                            <span class="text-white font-weight-bold text-body-2">{{ current_user.name[:1].upper() if current_user.name else 'U' }}</span>
                        </v-avatar>
                        
                        <div class="flex-grow-1 mr-2">
                            <div class="text-body-2 font-weight-medium text-truncate">
                                {{ current_user.name or 'User' }}
                            </div>
                            <div class="text-caption text-medium-emphasis">
                                {% if current_user.is_superadmin %}
                                    <v-chip size="x-small" color="primary" variant="tonal" class="px-2">
                                        <v-icon start size="12">mdi-shield-crown</v-icon>
                                        Admin
                                    </v-chip>
                                {% else %}
                                    <span class="text-truncate">{{ current_user.email }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <v-btn 
                            href="/logout" 
                            icon="mdi-logout" 
                            variant="text" 
                            size="small"
                            color="medium-emphasis"
                            class="ml-auto"
                        >
                            <v-icon size="18">mdi-logout</v-icon>
                            <v-tooltip activator="parent" location="top">Logout</v-tooltip>
                        </v-btn>
                    </v-card>
                </div>
            </template>
            {% endif %}
        </v-navigation-drawer>


        <v-main class="d-flex align-center justify-center" style="min-height: 300px;">
            {% block content %}
            {% endblock %}
        </v-main>
        
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" style="position: fixed; bottom: 20px; right: 20px; z-index: 2000;">
                {% for category, message in messages %}
                    <v-alert
                        dismissible
                        closable
                        variant="tonal"
                        color="{{ category if category in ['success', 'warning', 'error', 'info'] else 'primary' }}"
                        class="mb-2"
                        style="min-width: 250px;"
                    >
                        {{ message }}
                    </v-alert>
                {% endfor %}
            </div>
            
            <script>
                // Auto-hide flash messages after 5 seconds
                setTimeout(function() {
                    const flashMessages = document.getElementById('flash-messages');
                    if (flashMessages) {
                        flashMessages.style.display = 'none';
                    }
                }, 5000);
            </script>
        {% endif %}
        {% endwith %}
    </v-layout>
</v-app>
<script src="/static/js/vue.min.js"></script>
<script src="/static/js/config.js"></script>
<script src="/static/js/vuetify.min.js"></script>
<script src="/static/js/axios.min.js"></script>
{% block js %}{% endblock %}
</body>
</html>
