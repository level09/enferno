{% extends 'layout.html' %}
{% block content %}

<v-container fluid class="pa-4">
    <!-- Header Section -->
    <v-row class="mb-6">
        <v-col cols="12">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <h1 class="text-h4 font-weight-medium mb-1">
                        {% if current_user.is_superadmin %}
                            Platform Overview
                        {% else %}
                            Your Workspaces
                        {% endif %}
                    </h1>
                    <p class="text-body-2 text-medium-emphasis">
                        {% if current_user.is_superadmin %}
                            Manage the entire platform, workspaces, and users
                        {% else %}
                            Choose a workspace to get started
                        {% endif %}
                    </p>
                </div>
                {% if current_user.is_superadmin %}
                <v-btn 
                    color="primary" 
                    variant="elevated"
                    prepend-icon="mdi-plus"
                    @click="createDialog = true"
                    size="default"
                >
                    Create Workspace
                </v-btn>
                {% endif %}
            </div>
        </v-col>
    </v-row>


    <!-- Workspaces Section -->
    <div v-if="workspaces.length > 0">
        <div class="d-flex align-center mb-4">
            <h2 class="text-h5 font-weight-medium">
                {% if current_user.is_superadmin %}
                    All Workspaces
                {% else %}
                    Your Workspaces
                {% endif %}
            </h2>
            <v-spacer></v-spacer>
            <v-chip size="small" variant="outlined">${workspaces.length} workspace${workspaces.length !== 1 ? 's' : ''}</v-chip>
        </div>
        
        <v-row>
            <v-col 
                v-for="workspace in workspaces" 
                :key="workspace.id"
                cols="12" 
                sm="6" 
                lg="4"
            >
                <v-card 
                    :href="`/workspace/${workspace.id}/switch/`"
                    variant="elevated"
                    hover
                    class="h-100"
                >
                    <v-card-text class="pa-4">
                        <div class="d-flex align-center mb-3">
                            <v-avatar size="40" :color="workspace.is_pro ? 'success' : 'primary'" variant="tonal">
                                <v-icon>${workspace.is_pro ? 'mdi-briefcase-check' : 'mdi-briefcase-outline'}</v-icon>
                            </v-avatar>
                            <div class="ml-3 flex-grow-1">
                                <div class="d-flex align-center">
                                    <div class="text-h6 font-weight-medium mr-2">${workspace.name}</div>
                                    <v-chip v-if="workspace.is_pro" size="x-small" color="success" variant="flat">Pro</v-chip>
                                </div>
                                <div class="text-body-2 text-medium-emphasis">
                                    {% if current_user.is_superadmin %}
                                        Client workspace
                                    {% else %}
                                        Your role: ${workspace.user_role}
                                    {% endif %}
                                </div>
                            </div>
                            {% if current_user.is_superadmin %}
                            <v-chip size="small" color="warning" variant="tonal">
                                <v-icon start size="16">mdi-crown</v-icon>
                                Super Admin
                            </v-chip>
                            {% else %}
                            <v-chip 
                                size="small" 
                                :color="workspace.user_role === 'admin' ? 'primary' : 'default'"
                                variant="tonal"
                            >
                                ${workspace.user_role}
                            </v-chip>
                            {% endif %}
                        </div>
                        
                        <v-divider class="mb-3"></v-divider>
                        
                        <div class="d-flex justify-space-between text-body-2 text-medium-emphasis">
                            <span>Last accessed</span>
                            <span>Recently</span>
                        </div>
                    </v-card-text>
                </v-card>
            </v-col>
        </v-row>
    </div>

    <!-- Empty State -->
    <div v-else class="text-center py-16">
        <v-avatar size="120" color="grey-lighten-4" class="mb-6">
            <v-icon size="60" color="grey-lighten-1">mdi-briefcase-plus-outline</v-icon>
        </v-avatar>
        <h2 class="text-h4 font-weight-medium mb-3">No workspaces yet</h2>
        <p class="text-body-1 text-medium-emphasis mb-8">
            {% if current_user.is_superadmin %}
                Create your first workspace to get started with the platform.
            {% else %}
                Contact your administrator to join a workspace.
            {% endif %}
        </p>
        {% if current_user.is_superadmin %}
        <v-btn 
            color="primary" 
            size="large"
            variant="elevated"
            @click="createDialog = true"
            prepend-icon="mdi-plus"
        >
            Create Your First Workspace
        </v-btn>
        {% endif %}
    </div>
    
</v-container>

<!-- Create Workspace Dialog -->
<v-dialog v-model="createDialog" max-width="500" persistent>
    <v-card>
        <v-card-title class="d-flex align-center justify-space-between">
            <div class="d-flex align-center">
                <v-icon color="primary" class="mr-3">mdi-briefcase-plus</v-icon>
                <span>Create New Workspace</span>
            </div>
            <v-btn @click="createDialog=false" icon="mdi-close" variant="text" size="small"></v-btn>
        </v-card-title>

        <v-card-text class="pb-0">
            <v-text-field
                label="Workspace Name"
                v-model="newWorkspaceName"
                :rules="[rules.required]"
                placeholder="e.g. Acme Corporation"
                variant="outlined"
                prepend-inner-icon="mdi-domain"
                hide-details="auto"
                class="mb-4"
            ></v-text-field>
            <v-alert type="info" variant="tonal" class="mb-4">
                <template v-slot:prepend>
                    <v-icon>mdi-information</v-icon>
                </template>
                You'll be the admin of this workspace and can invite team members later.
            </v-alert>
        </v-card-text>

        <v-card-actions class="px-6 pb-6">
            <v-spacer></v-spacer>
            <v-btn @click="createDialog=false" variant="text" :disabled="creating">
                Cancel
            </v-btn>
            <v-btn 
                color="primary" 
                @click="createWorkspace" 
                :loading="creating"
                variant="elevated"
                prepend-icon="mdi-plus"
            >
                Create Workspace
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>

<v-snackbar 
    v-model="snackBar" 
    :color="snackColor"
    location="top right"
    timeout="4000"
    variant="elevated"
>
    <div class="d-flex align-center">
        <v-icon 
            :icon="snackColor === 'success' ? 'mdi-check-circle' : 'mdi-alert-circle'" 
            class="mr-2"
        ></v-icon>
        ${snackMessage}
    </div>
    <template v-slot:actions>
        <v-btn icon="mdi-close" @click="snackBar=false" variant="text" size="small"></v-btn>
    </template>
</v-snackbar>


{% endblock %}

{% block js %}
<script>
const { createApp } = Vue;
const { createVuetify } = Vuetify;
const vuetify = createVuetify(config.vuetifyConfig);

const app = createApp({
    data() {
        return {
            menu: null,
            drawer: true,
            workspaces: [],
            createDialog: false,
            newWorkspaceName: '',
            creating: false,
            snackBar: false,
            snackMessage: '',
            snackColor: 'success',

            rules: {
                required: value => !!value || 'Required'
            }
        };
    },
    delimiters: config.delimiters,
    
    mounted() {
        // Load workspace data from template (already includes user roles)
        this.workspaces = {{ workspaces | tojson | safe }};
    },
    
    methods: {
        showSnack(message, color = 'success') {
            this.snackMessage = message;
            this.snackColor = color;
            this.snackBar = true;
        },
        
        async createWorkspace() {
            if (!this.newWorkspaceName.trim()) {
                this.showSnack('Workspace name is required', 'error');
                return;
            }
            
            this.creating = true;
            
            try {
                const response = await axios.post('/api/workspaces', {
                    name: this.newWorkspaceName.trim()
                });
                
                this.showSnack('Workspace created successfully!');
                this.createDialog = false;
                this.newWorkspaceName = '';
                
                // Redirect to the new workspace
                window.location.href = `/workspace/${response.data.workspace.id}/switch/`;
                
            } catch (error) {
                this.showSnack(
                    error.response?.data?.error || 'Failed to create workspace', 
                    'error'
                );
            } finally {
                this.creating = false;
            }
        },

        formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }
});

app.use(vuetify).mount('#app');
</script>
{% endblock %}
